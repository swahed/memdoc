# MemDoc Update Process

## Overview

MemDoc includes an automatic update mechanism that checks GitHub Releases for new versions, downloads updates, and applies them safely with rollback support.

**Current Status:** ‚ö†Ô∏è **NOT FULLY WORKING** - See `UPDATE_MECHANISM_DEBUG_NOTES.md` for details.

## How Updates Work

### Automatic Update Check
- **When:** On app startup
- **Frequency:** Once per session
- **Behavior:** Silent check, shows banner if update available
- **Network:** Requires internet connection

### Manual Update Check
- **Where:** Settings ‚Üí Software Updates
- **Action:** Click "Check for Updates Now"
- **Result:** Immediate check, shows status message

## Update Flow (User Perspective)

### Step 1: Update Available
```
App startup
    ‚Üì
Auto-check GitHub Releases
    ‚Üì
New version found
    ‚Üì
Blue banner appears at top:
"Version X.Y.Z available - New features and improvements"
[Details] [√ó]
```

### Step 2: View Details
```
Click "Details"
    ‚Üì
Update modal opens
    ‚Üì
Shows:
- Current version: 1.1.0
- New version: 1.2.0
- Release date
- What's new (release notes)
- Download size
```

### Step 3: Download
```
Click "Download"
    ‚Üì
Progress bar shows download
"Downloading... 45%"
"5.2 MB / 11.5 MB"
    ‚Üì
Download completes
    ‚Üì
"Install & Restart" button appears
```

### Step 4: Install
```
Click "Install & Restart"
    ‚Üì
Confirmation dialog:
"Update will now install. App will restart.
Do you want to continue?"
    ‚Üì
Click "OK"
    ‚Üì
App closes
Update script runs
.exe replaced
App reopens
    ‚Üì
New version running!
```

## Technical Implementation

### Components

#### Frontend (JavaScript)
**File:** `static/js/app.js`

**Key Methods:**
- `checkForUpdatesOnStartup()` - Auto-check on load
- `manualCheckForUpdates()` - Manual check button
- `showUpdateBanner()` - Display update notification
- `startDownload()` - Download with progress tracking
- `installUpdate()` - Trigger installation

#### Backend (Python)
**File:** `core/updater.py`

**Key Functions:**
- `check_for_updates()` - Query GitHub API
- `download_update()` - Download with progress callback
- `backup_current_version()` - Backup before update
- `apply_update()` - Create and launch update script
- `rollback_to_version()` - Restore previous version

#### API Endpoints
**File:** `app.py`

- `GET /api/version` - Current version info
- `GET /api/updates/check` - Check for updates
- `POST /api/updates/download` - Start background download
- `GET /api/updates/download/status` - Poll download progress
- `POST /api/updates/install` - Install and restart
- `GET /api/updates/backups` - List available backups
- `POST /api/updates/rollback` - Rollback to version

### Update Script (Windows Batch)

**Location:** `%APPDATA%\MemDoc\backups\update.bat`

**Generated by:** `apply_update()` in `updater.py`

**Script:**
```batch
@echo off
timeout /t 2 /nobreak >nul
move /y "new.exe" "current.exe" >nul 2>&1
if errorlevel 1 (
    echo Update failed - could not replace executable
    pause
    exit /b 1
)
start "" "current.exe"
del "%~f0"
```

**Process:**
1. Wait 2 seconds for app to exit
2. Replace old .exe with new .exe
3. Start new .exe
4. Delete itself

## Version Detection

### Dev Mode vs. Production
- **Dev mode:** Updates disabled (running from source)
- **Production:** Updates enabled (running from .exe)

**Detection:**
```javascript
const isBundled = document.body.dataset.isBundled === 'true';
this.isDevMode = !isBundled;
```

**Backend:**
```python
is_bundled = getattr(sys, 'frozen', False)
```

### Test Builds
- Updates always disabled for test builds
- Prevents accidental upgrade of test version
- Test builds show warning banner

## Safety Features

### Backup Before Update
**Location:** `%APPDATA%\MemDoc\backups\vX.Y.Z\`

**Contains:**
- Old MemDoc.exe (renamed with version)
- backup_info.json (metadata)
- Timestamp, version, size

**Kept:** Unlimited (user can manually delete)

### Integrity Verification
```python
def verify_exe_integrity(exe_path: Path) -> bool:
    # Check file size (should be 25-35 MB)
    if size_mb < 25 or size_mb > 35:
        return False

    # Check file extension
    if not exe_path.suffix.lower() == '.exe':
        return False

    return True
```

### Rollback Support
**How to rollback:**
1. Settings ‚Üí Software Updates
2. Scroll to "Previous Versions"
3. Click "Restore" on desired version
4. Confirm
5. App restarts with old version

## Known Issues (Current)

### ‚ùå Installation Hangs
**Symptom:** Progress bar reaches 100%, shows "Restarting app..." but nothing happens

**Cause:** App doesn't exit properly, .exe remains locked

**Workaround:** None - requires code fix

### ‚ùå Update Not Applied
**Symptom:** After clicking Install, app closes but doesn't restart. Opening manually shows old version still running.

**Cause:** Batch script fails to replace .exe (locked or timing issue)

**Workaround:** Manual update (download new .exe, replace old one)

### ‚ö†Ô∏è No Error Messages
**Symptom:** Silent failure - no indication what went wrong

**Cause:** Batch script runs in background with no error logging

**Planned Fix:** Add logging to update script

## Release Process

### For Developers

#### 1. Prepare Release
```bash
# Update version
Edit core/version.py: VERSION = "1.2.0"

# Update changelog
Edit CHANGELOG.md: Add v1.2.0 section

# Commit
git add core/version.py CHANGELOG.md
git commit -m "Bump version to 1.2.0"
git push origin main
```

#### 2. Create Tag
```bash
git tag -a v1.2.0 -m "Release v1.2.0"
git push origin v1.2.0
```

#### 3. GitHub Actions Builds
- Workflow: `.github/workflows/release.yml`
- Trigger: Tag push
- Duration: ~2-3 minutes
- Output: `MemDoc.exe` uploaded to GitHub Release

#### 4. Edit Release Notes
1. Go to: https://github.com/swahed/memdoc/releases
2. Find v1.2.0 release
3. Click "Edit"
4. Fill in:
   - **Title:** MemDoc 1.2.0
   - **Description:** Use template from `.github/RELEASE_TEMPLATE.md`
   - Add: What's new, bug fixes, installation instructions
5. Save

### Release Notes Template

**English (for GitHub - public):**
```markdown
## What's New in 1.2.0

### ‚ú® New Features
- Feature description

### üîß Improvements
- Improvement description

### üêõ Bug Fixes
- Bug fix description

## Installation

1. Download `MemDoc.exe`
2. Run the file
3. Windows may show security warning - click "More info" ‚Üí "Run anyway"
4. Choose a folder for your memoir (OneDrive recommended for backup)

## For Existing Users

### Automatic Update (Recommended)
1. Open MemDoc
2. Click "Details" in update banner
3. Click "Download"
4. Click "Install & Restart"

### Manual Update
1. Download new `MemDoc.exe`
2. Replace old .exe file
3. Your data remains safe (stored separately)

### Rollback
If you experience issues:
1. Settings ‚Üí Software Updates
2. "Previous Versions" section
3. Click "Restore" on previous version

---

**Full changelog:** [CHANGELOG.md](../CHANGELOG.md)

ü§ñ Built with GitHub Actions
```

**German (for app UI - currently used):**
```markdown
## Was ist neu in 1.2.0?

### Neue Features
- Feature-Beschreibung

### Verbesserungen
- Verbesserungs-Beschreibung

### Fehlerbehebungen
- Bugfix-Beschreibung
```

## Future Improvements

### Short Term
1. ‚úÖ Fix app exit after update installation
2. ‚úÖ Add logging to update batch script
3. ‚úÖ Increase timeout in batch script
4. ‚úÖ Better error messages in UI

### Medium Term
1. ‚¨ú Progress during installation (not just download)
2. ‚¨ú Verify .exe signature (when code-signed)
3. ‚¨ú Delta updates (only download changes)
4. ‚¨ú Update in background (no restart required)

### Long Term
1. ‚¨ú Use professional update framework (Squirrel.Windows, PyUpdater)
2. ‚¨ú Auto-update without user intervention (optional)
3. ‚¨ú Beta/stable channels
4. ‚¨ú Partial rollback (config only, not .exe)

## Testing Updates

### Test Locally

**Simulate version difference:**
```python
# In core/version.py
VERSION = "1.0.0"  # Pretend we're on old version
```

**Run app:**
```bash
python app.py
```

**Check:** Should detect newer version on GitHub

### Test Full Flow

**Requirements:**
- Two built .exe versions (e.g., v1.1.0 and v1.2.0)
- v1.2.0 published to GitHub Releases

**Steps:**
1. Run v1.1.0
2. Check for updates ‚Üí should find v1.2.0
3. Download ‚Üí verify progress
4. Install ‚Üí verify .exe replaced
5. Restart ‚Üí verify v1.2.0 running
6. Rollback ‚Üí verify v1.1.0 restored

## Troubleshooting

### "Updates not available in dev mode"
**Cause:** Running from source (`python app.py`)

**Solution:** Build .exe and run that, or set `is_bundled=true` for testing

### "No update found" when newer version exists
**Possible causes:**
1. Repository is private (API returns 404)
2. Release is draft or pre-release
3. No .exe asset in release
4. Network/firewall blocking GitHub API

**Check:**
```bash
curl https://api.github.com/repos/swahed/memdoc/releases/latest
```

### Download fails or is very slow
**Causes:**
- Poor internet connection
- GitHub rate limiting (60 requests/hour for unauthenticated)
- Firewall blocking

**Solutions:**
- Wait and retry
- Check internet connection
- Manually download from GitHub

### App doesn't restart after update
**Cause:** Update script failed or app didn't exit

**Solutions:**
1. Close app manually
2. Check if .exe was replaced (file modified time)
3. Run new .exe manually
4. Check logs: `%TEMP%\memdoc_update.log` (if logging added)

## References

- GitHub Releases API: https://docs.github.com/rest/releases
- PyInstaller docs: https://pyinstaller.org/
- Windows batch scripts: https://ss64.com/nt/
- Auto-update patterns: https://github.com/topics/auto-update
- Squirrel.Windows: https://github.com/Squirrel/Squirrel.Windows
