<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemDoc - Memoiren schreiben</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body data-is-bundled="{{ 'true' if is_bundled else 'false' }}">
    <!-- Test Build Warning Banner -->
    {% if is_test_build %}
    <div class="test-build-warning">
        ‚ö†Ô∏è TEST VERSION - Using sample data only (Branch: {{ test_build_branch }})
    </div>
    {% endif %}

    <!-- Update Available Banner -->
    <div class="update-banner" id="updateBanner" style="display: none;">
        <div class="update-banner-content">
            <span class="update-banner-icon">üîÑ</span>
            <span class="update-banner-message">
                <strong>Version <span id="updateBannerVersion"></span> verf√ºgbar</strong> ‚Äì
                <span id="updateBannerDescription"></span>
            </span>
        </div>
        <div class="update-banner-actions">
            <button class="btn-update-banner" id="btnShowUpdateModal">Details</button>
            <button class="btn-dismiss-update" id="btnDismissUpdate" title="Nicht mehr anzeigen">&times;</button>
        </div>
    </div>

    <!-- Update Download Progress Banner -->
    <div class="update-banner downloading" id="updateBannerDownloading" style="display: none;">
        <div class="update-banner-content">
            <span class="update-banner-spinner">‚è≥</span>
            <span class="update-banner-message">
                <strong>Update wird heruntergeladen...</strong>
                <span id="downloadProgressPct">0%</span>
            </span>
        </div>
        <div class="update-progress-mini">
            <div class="update-progress-fill" id="downloadProgressFill" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Sidebar - Chapter Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="app-title-row">
                    <h1 class="app-title">MemDoc</h1>
                    <button class="btn-settings-icon" id="btnSettings" title="Einstellungen">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                        </svg>
                    </button>
                </div>
                <div class="cover-tile" id="coverTile" title="Titelseite bearbeiten">
                    <div class="cover-tile-preview" id="coverTilePreview">
                        <div class="cover-tile-image" id="coverTileImage"></div>
                        <div class="cover-tile-text">
                            <div class="cover-tile-title" id="coverTileTitle">Titel deiner Memoiren</div>
                            <div class="cover-tile-subtitle" id="coverTileSubtitle"></div>
                        </div>
                    </div>
                    <button class="cover-tile-edit" id="coverTileEdit" title="Titelseite bearbeiten">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M12.146.854a.5.5 0 0 1 .708 0l2.292 2.292a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 3 10.707V11h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l7.5-7.5z"/>
                        </svg>
                    </button>
                </div>
                <button class="btn-new-chapter" id="btnNewChapter">+ Neues Kapitel</button>
            </div>

            <nav class="chapter-list" id="chapterList">
                <p class="empty-state">Noch keine Kapitel. Erstelle dein erstes Kapitel!</p>
            </nav>

            <div class="sidebar-footer">
                <button class="btn-sidebar-footer" id="btnFullPreview" title="Buch-Vorschau">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 2c3.5 0 6.5 2.5 8 6-1.5 3.5-4.5 6-8 6s-6.5-2.5-8-6c1.5-3.5 4.5-6 8-6zm0 10c2 0 3.5-1.5 3.5-3.5S10 5 8 5 4.5 6.5 4.5 8.5 6 12 8 12zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/>
                    </svg>
                    Buch-Vorschau
                </button>
            </div>
        </aside>

        <!-- Main Editor Area -->
        <main class="editor-container">
            <!-- Editor Header -->
            <header class="editor-header">
                <input
                    type="text"
                    class="chapter-title-input"
                    id="chapterTitle"
                    placeholder="Kapiteltitel"
                    disabled
                />
                <input
                    type="text"
                    class="chapter-subtitle-input"
                    id="chapterSubtitle"
                    placeholder="Untertitel (optional)"
                    disabled
                />
            </header>

            <!-- Formatting Toolbar -->
            <div class="formatting-toolbar" id="formattingToolbar">
                <button class="format-btn" id="btnBold" title="Fett (Strg+B)" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4 2h5a3 3 0 0 1 0 6H4zm0 6h6a3 3 0 0 1 0 6H4z"/>
                    </svg>
                </button>
                <button class="format-btn" id="btnItalic" title="Kursiv (Strg+I)" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M10 2h4l-6 12H4l6-12z"/>
                    </svg>
                </button>
                <button class="format-btn" id="btnClearFormat" title="Formatierung entfernen" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="3" x2="13" y2="13"/>
                        <line x1="13" y1="3" x2="3" y2="13"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="format-btn" id="btnH1" title="√úberschrift 1" disabled>H1</button>
                <button class="format-btn" id="btnH2" title="√úberschrift 2" disabled>H2</button>
                <button class="format-btn" id="btnH3" title="√úberschrift 3" disabled>H3</button>
                <div class="toolbar-separator"></div>
                <button class="format-btn" id="btnInsertImage" title="Bild einf√ºgen" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3zm11 1H3v6.5l2.5-2.5 1.5 1.5 3-3 3 3V4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                    </svg>
                </button>
                <div class="toolbar-separator"></div>
                <button class="format-btn format-btn-label" id="btnPreview" title="Kapitel-Vorschau" disabled>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 2c3.5 0 6.5 2.5 8 6-1.5 3.5-4.5 6-8 6s-6.5-2.5-8-6c1.5-3.5 4.5-6 8-6zm0 10c2 0 3.5-1.5 3.5-3.5S10 5 8 5 4.5 6.5 4.5 8.5 6 12 8 12zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/>
                    </svg>
                    Kapitel-Vorschau
                </button>
            </div>

            <!-- Editor Content -->
            <div class="editor-content">
                <textarea
                    class="markdown-editor"
                    id="editor"
                    placeholder="Beginne deine Memoiren zu schreiben...

Du kannst einfache Formatierung verwenden:
**fett** f√ºr fetten Text
*kursiv* f√ºr kursiven Text
# √úberschrift f√ºr Abschnitts√ºberschriften"
                    disabled
                ></textarea>
            </div>

            <!-- Status Bar -->
            <footer class="status-bar">
                <span class="status-indicator" id="saveStatus">Bereit</span>
                <span class="word-count" id="wordCount">0 W√∂rter</span>
                <span class="version-info">v{{ version }}</span>
            </footer>
        </main>

    </div>

    <!-- Image Upload Modal -->
    <div class="modal-overlay" id="imageUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Bild einf√ºgen</h3>
                <button class="btn-close-modal" id="btnCloseImageModal">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Drag-drop upload area -->
                <div class="upload-dropzone" id="uploadDropzone">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    <p>Bild hierher ziehen oder klicken zum Durchsuchen</p>
                    <p class="upload-hint">JPG, PNG, GIF, WebP - Max. 20MB</p>
                    <input type="file" accept="image/*" id="imageFileInput" hidden>
                </div>

                <!-- Preview area (hidden initially) -->
                <div class="upload-preview" id="uploadPreview" hidden>
                    <img id="previewImage" src="" alt="Vorschau">

                    <!-- Image info -->
                    <div class="image-info">
                        <div class="info-row">
                            <strong>Datei:</strong> <span id="infoFilename"></span>
                        </div>
                        <div class="info-row">
                            <strong>Gr√∂√üe:</strong> <span id="infoFileSize"></span>
                        </div>
                        <div class="info-row">
                            <strong>Abmessungen:</strong> <span id="infoDimensions"></span>
                        </div>
                    </div>

                    <!-- Warnings -->
                    <div id="imageWarnings" class="warnings"></div>

                    <!-- Image options -->
                    <div class="image-options">
                        <div class="option-group">
                            <label for="imagePosition">Position:</label>
                            <select id="imagePosition">
                                <option value="center">Zentriert</option>
                                <option value="left">Links (Text umflie√üt)</option>
                                <option value="right">Rechts (Text umflie√üt)</option>
                                <option value="full">Volle Breite</option>
                            </select>
                        </div>

                        <div class="option-group">
                            <label for="imageSize">Anzeigegr√∂√üe:</label>
                            <select id="imageSize">
                                <option value="small">Klein (300px)</option>
                                <option value="medium" selected>Mittel (500px)</option>
                                <option value="large">Gro√ü (700px)</option>
                                <option value="full">Volle Breite</option>
                            </select>
                        </div>

                        <div class="option-group full-width">
                            <label for="imageCaption">Bildunterschrift (optional):</label>
                            <input type="text" id="imageCaption" placeholder="Beschreibe das Foto...">
                        </div>
                    </div>

                    <!-- Helpful tips -->
                    <div class="image-tips">
                        <h4>üí° Tipps f√ºr beste Ergebnisse:</h4>
                        <ul>
                            <li>Verwende Originalfotos von Kamera/Scanner (keine Screenshots)</li>
                            <li>Ziele auf mindestens 1500 Pixel Breite f√ºr gute Druckqualit√§t</li>
                            <li>Mittlere Gr√∂√üe (500px) funktioniert gut f√ºr die meisten Memoiren-Fotos</li>
                            <li>JPG-Format ist am besten f√ºr Fotos, PNG f√ºr Diagramme</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Modal actions -->
            <div class="modal-actions">
                <button class="btn-secondary" id="btnCancelUpload">Abbrechen</button>
                <button class="btn-primary" id="btnInsertImageToEditor" disabled>Bild einf√ºgen</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal-content preview-modal-content">
            <div class="modal-header">
                <h3 id="previewModalTitle">Kapitel-Vorschau</h3>
                <button class="btn-close-modal" id="btnClosePreview">&times;</button>
            </div>

            <div class="modal-body preview-body">
                <iframe id="previewFrame" sandbox="allow-same-origin"></iframe>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" id="btnClosePreviewBottom">Schlie√üen</button>
                <button class="btn-primary" id="btnExportFromPreview">Als PDF exportieren</button>
            </div>
        </div>
    </div>

    <!-- Cover Page Modal -->
    <div class="modal-overlay" id="coverPageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Titelseite bearbeiten</h3>
                <button class="btn-close-modal" id="btnCloseCoverModal">&times;</button>
            </div>

            <div class="modal-body">
                <div class="cover-editor">
                    <div class="form-group">
                        <label for="coverTitleInput">Titel</label>
                        <input type="text" id="coverTitleInput" class="form-input" placeholder="Titel deiner Memoiren">
                    </div>

                    <div class="form-group">
                        <label for="coverSubtitleInput">Untertitel</label>
                        <input type="text" id="coverSubtitleInput" class="form-input" placeholder="Untertitel (optional)">
                    </div>

                    <div class="form-group">
                        <label for="coverAuthorInput">Autor</label>
                        <input type="text" id="coverAuthorInput" class="form-input" placeholder="Dein Name">
                    </div>

                    <div class="form-group">
                        <label>Titelbild (optional)</label>
                        <div class="cover-image-upload">
                            <input type="file" id="coverImageInput" accept="image/*" hidden>
                            <button class="btn-secondary" id="btnChooseCoverImage">Titelbild w√§hlen</button>
                            <button class="btn-secondary" id="btnRemoveCoverImage" style="display: none;">Titelbild entfernen</button>
                        </div>
                        <div id="coverImagePreview" class="cover-image-preview" style="display: none;">
                            <img id="coverImagePreviewImg" src="" alt="Titelbild">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Hintergrundfarbe</label>
                        <div class="color-picker-container">
                            <div id="suggestedColors" class="suggested-colors" style="display: none;">
                                <p class="suggested-colors-label">Vorgeschlagene Farben:</p>
                                <div id="colorSuggestions" class="color-suggestions"></div>
                            </div>
                            <div class="custom-color-picker">
                                <input type="color" id="coverColorInput" value="#f5f5f5">
                                <span class="color-picker-label">Eigene Farbe w√§hlen</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="cover-preview-container">
                    <h4>Vorschau</h4>
                    <div class="cover-preview" id="coverPreview">
                        <div class="cover-preview-content">
                            <div id="coverPreviewImage" class="cover-preview-image" style="display: none;"></div>
                            <div class="cover-preview-text">
                                <h1 id="coverPreviewTitle" class="cover-preview-title">Titel deiner Memoiren</h1>
                                <h2 id="coverPreviewSubtitle" class="cover-preview-subtitle"></h2>
                                <p id="coverPreviewAuthor" class="cover-preview-author">Dein Name</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" id="btnCancelCover">Abbrechen</button>
                <button class="btn-primary" id="btnSaveCover">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Einstellungen</h3>
                <button class="btn-close-modal" id="btnCloseSettings">&times;</button>
            </div>

            <div class="modal-body">
                <div class="settings-section">
                    <h4>Software-Updates</h4>
                    <p class="section-description">
                        MemDoc sucht beim Start automatisch nach Updates. Du kannst auch manuell nach Updates suchen.
                    </p>

                    <div class="update-check-container">
                        <button class="btn-primary" id="btnCheckUpdates">Jetzt nach Updates suchen</button>
                        <p id="updateCheckStatus" class="update-check-status"></p>
                    </div>

                    <div class="current-version-info">
                        <label>Aktuelle Version:</label>
                        <code id="currentVersionDisplay">L√§dt...</code>
                    </div>
                </div>

                <div class="settings-divider"></div>

                <div class="settings-section">
                    <h4>Datenspeicherort</h4>
                    <p class="section-description">
                        Speichere deine Memoiren in einem OneDrive- oder anderen Cloud-Ordner f√ºr automatisches Backup.
                    </p>

                    <div class="current-location">
                        <label>Aktueller Speicherort:</label>
                        <div class="location-display">
                            <code id="currentDataPath">L√§dt...</code>
                        </div>
                        <div class="location-stats">
                            <span id="dataSize">-</span> ‚Ä¢ <span id="fileCount">-</span> Dateien
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="newDataPath">Neuer Speicherort:</label>
                        <div class="path-input-group">
                            <input
                                type="text"
                                id="newDataPath"
                                class="form-input"
                                placeholder="z.B. C:\Users\Name\OneDrive\MemDoc"
                            >
                            <button class="btn-secondary" id="btnBrowseFolder" title="Ordner ausw√§hlen">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2 2z"></path>
                                </svg>
                                Durchsuchen
                            </button>
                        </div>
                        <div id="pathValidationResult" class="validation-message"></div>
                    </div>

                    <div class="migration-options" id="migrationOptions">
                        <div class="checkbox-group">
                            <input type="checkbox" id="keepBackup" checked>
                            <label for="keepBackup">
                                Alte Daten als Backup behalten (empfohlen)
                            </label>
                        </div>

                        <button
                            class="btn-primary"
                            id="btnStartMigration"
                            disabled
                            title="Bitte erst einen Ordner ausw√§hlen"
                        >
                            Daten verschieben
                        </button>
                    </div>

                    <div class="migration-progress" id="migrationProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="migrationProgressBar"></div>
                        </div>
                        <p id="migrationStatus">Kopiere Dateien...</p>
                    </div>

                    <div class="info-box">
                        <strong>Hinweis:</strong> Nach dem Verschieben wird die Anwendung neu gestartet.
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" id="btnCancelSettings">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Subfolder Name Prompt -->
    <div class="modal-overlay" id="subfolderPrompt" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3>Unterordner benennen</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: #666;">
                    Gew√§hlter Ordner: <strong id="selectedParentPath"></strong>
                </p>
                <div class="form-group">
                    <label for="subfolderName">Name f√ºr den Memoir-Ordner:</label>
                    <input
                        type="text"
                        id="subfolderName"
                        class="form-input"
                        value="MemDoc"
                        placeholder="z.B. MemDoc oder Meine-Memoiren"
                    >
                    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                        Vollst√§ndiger Pfad: <code id="fullPathPreview" style="color: #2196F3;"></code>
                    </p>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="btnCancelSubfolder">Abbrechen</button>
                <button class="btn-primary" id="btnConfirmSubfolder">OK</button>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal-overlay" id="updateModal">
        <div class="modal-content update-modal-content">
            <div class="modal-header">
                <h3>Update verf√ºgbar</h3>
                <button class="btn-close-modal" id="btnCloseUpdateModal">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Version Info -->
                <div class="update-version-info">
                    <div class="version-comparison">
                        <div class="version-item version-current">
                            <label>Aktuelle Version:</label>
                            <span id="currentVersion" class="version-number">...</span>
                        </div>
                        <div class="version-arrow">‚Üí</div>
                        <div class="version-item version-new">
                            <label>Neue Version:</label>
                            <span id="newVersion" class="version-number">...</span>
                        </div>
                    </div>
                    <div class="update-release-date">
                        <strong>Ver√∂ffentlicht:</strong> <span id="releaseDate">...</span>
                    </div>
                </div>

                <!-- Release Notes -->
                <div class="update-release-notes">
                    <h4>Was ist neu?</h4>
                    <div id="releaseNotesContent" class="release-notes-content">
                        <p class="loading">Lade √Ñnderungen...</p>
                    </div>
                </div>

                <!-- Download Progress (hidden initially) -->
                <div class="update-download-progress" id="updateDownloadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="updateProgressBar" style="width: 0%;"></div>
                    </div>
                    <p id="updateStatus" class="update-status-text">Lade Update herunter...</p>
                    <p class="download-details">
                        <span id="downloadedBytes">0 MB</span> / <span id="totalBytes">0 MB</span>
                    </p>
                </div>

                <!-- Rollback Section (hidden initially) -->
                <div class="update-rollback-section" id="updateRollbackSection" style="display: none;">
                    <h4>Fr√ºhere Versionen</h4>
                    <p class="section-description">
                        Falls nach dem Update Probleme auftreten, kannst du zu einer fr√ºheren Version zur√ºckkehren.
                    </p>
                    <div class="backup-list" id="backupList">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" id="btnCancelUpdate">Sp√§ter</button>
                <button class="btn-primary" id="btnDownloadUpdate">Herunterladen</button>
                <button class="btn-primary" id="btnInstallUpdate" style="display: none;">Installieren & Neustarten</button>
            </div>
        </div>
    </div>

    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/editor.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
